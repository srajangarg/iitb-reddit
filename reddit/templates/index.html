<!DOCTYPE html>
<html lang="en">
{% load staticfiles %}
<head>
	<link rel="stylesheet" href={% static "css/bootstrap.css" %}>
	<script type="text/javascript" src={% static "js/jquery.1.11.1.js" %}></script>
	<script type="text/javascript">
	var voteStatus = [];
	var numVotes = [];
	{% for p in posts %}
		voteStatus[{{p.id}}] = {{p.vote}}
		numVotes[{{p.id}}] = {{p.num_votes}}
	{% endfor %}
	$( document ).ready(function() {
		var $divs = $("div.col-md-8");
		$('#new').on('click', function () {
		    var numericallyOrderedDivs = $divs.sort(function (a, b) {
		    	// console.log($(a).find("span").text());
		    	// if (parseInt($(a).find("span").text()) < 5)
		     //    	$(a).css ("display","none");
		    	// if (parseInt($(b).find("span").text()) < 5)
		     //    	$(b).css ("display","none");
		        return Date.parse($(a).find("#time").text()) < Date.parse($(b).find("#time").text());
		    });
		    $("#container").html(numericallyOrderedDivs);
		});

		$('#hot').on('click', function () {
		    var numericallyOrderedDivs = $divs.sort(function (a, b) {
		        return parseInt($(a).find("#votes").text()) < parseInt($(b).find("#votes").text());
		    });
		    $("#container").html(numericallyOrderedDivs);
		});

		$('#rising').on('click', function () {
		    var numericallyOrderedDivs = $divs.sort(function (a, b) {
		        return Date.parse($(a).find("#time").text()) < Date.parse($(b).find("#time").text());
		    });
		    $("#container").html(numericallyOrderedDivs);
		});

		$('#day').on('click', function () {
		    var numericallyOrderedDivs = $divs.sort(function (a, b) {
		    	if (Date($.now()) - Date.parse($(a).find("#time").text()) < 5)
		        	$(a).css ("display","none");
		    	if (parseInt($(b).find("span").text()) < 5)
		        	$(b).css ("display","none");
		        return parseInt($(a).find("#votes").text()) < parseInt($(b).find("#votes").text());
		    });
		    $("#container").html(numericallyOrderedDivs);
		});

		$('#week').on('click', function () {
		    var numericallyOrderedDivs = $divs.sort(function (a, b) {
		        return parseInt($(a).find("#votes").text()) < parseInt($(b).find("#votes").text());
		    });
		    $("#container").html(numericallyOrderedDivs);
		});

		$('#month').on('click', function () {
		    var numericallyOrderedDivs = $divs.sort(function (a, b) {
		        return parseInt($(a).find("#votes").text()) < parseInt($(b).find("#votes").text());
		    });
		    $("#container").html(numericallyOrderedDivs);
		});

		$('#year').on('click', function () {
		    var numericallyOrderedDivs = $divs.sort(function (a, b) {
		        return parseInt($(a).find("#votes").text()) < parseInt($(b).find("#votes").text());
		    });
		    $("#container").html(numericallyOrderedDivs);
		});

		$('#all').on('click', function () {
		    var numericallyOrderedDivs = $divs.sort(function (a, b) {
		        return parseInt($(a).find("#votes").text()) < parseInt($(b).find("#votes").text());
		    });
		    $("#container").html(numericallyOrderedDivs);
		});
	});

		function vote (obj, id, type) {
			$.ajax({type: "POST",
	            url: "{% url 'vote' %}",
	            data: { 
	            	action: type, 
	            	postId: id, 
	            	status: voteStatus[id],
	            	csrfmiddlewaretoken: '{{ csrf_token }}'
	            },
	            success:function(data,status){
	            	if (data.success == true)
	            	{
	            		data.vote = parseInt(data.vote);
	            		numVotes[id] += data.vote - voteStatus[id];
	            		$(obj.parentNode).find("#votes").text(numVotes[id]);
		    			voteStatus[id] = data.vote;
		    			if(voteStatus[id] == 1)
		    				$(obj.parentNode).find("#upvote")[0].style.color = "green";
		    			else	
		    				$(obj.parentNode).find("#upvote")[0].style.color = "silver";

		    			if(voteStatus[id] == -1)
		    				$(obj.parentNode).find("#downvote")[0].style.color = "red";
		    			else	
		    				$(obj.parentNode).find("#downvote")[0].style.color = "silver";
	            	}
	    		}
	    	});
		}
	</script>
</head>

<body>
	<!-- Navbar -->
	<div class="navbar navbar-inverse" >
		<div class="container" style="margin-left:0px;margin-right:0px;width:98%">
			<div class="navbar-header pull-left">
				<a class="navbar-brand" href={% url 'index' %}><img src={% static "images/a.png" %} style="height:45px;width:70px"></a>
			</div>
			<div class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li><a id="hot">HOT</a></li>
					<li><a id="new">NEW</a></li>
					<li><a id="rising">RISING</a></li>
					<li class="dropdown">
						<a id="top" class="dropdown-toggle" data-toggle="dropdown">TOP</a>
						<ul class="dropdown-menu">
							<li><a id="day">Past 24hrs</a></li>
							<li><a id="week">Past Week</a></li>
							<li><a id="month">Past Month</a></li>
							<li><a id="year">Past Year</a></li>
							<li><a id="all">All Time</a></li>
						</ul>
					</li>
				</ul>
				<ul class="nav navbar-nav pull-right">
					{% if user.is_authenticated %}
					<li><a href={% url 'user' user %}>{{ user }} </a></li>
					<li><a href={% url 'logout'%}>Logout</a></li>
					{% else %}
					<li><a href="" data-toggle="modal" data-target="#myModal">Login or SignUp</a></li>
					{% endif %}
				</ul>
			</div>
		</div>
	</div>

	<!-- Modal (Login Pop up) -->
	<div id="myModal" class="modal" role="dialog" tabindex='-1'>
	<center>
		<div class="modal-lg">
	    <div class="modal-content">
	    	<div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal">&times;</button>
		    </div>
	    	<div class="modal-body">
		        <div class="col-md-6" style="border-right: 1px solid #ddd;">
		        	<h5 style="color:#049">CREATE ACCOUNT</h5>
		        	<form role="form" action="{% url 'signup' %}" method="post">
			        {% csrf_token %}
			        	<input type="text" class="form-control" name="name" id="name" placeholder="Enter Name">
			        	<input type="text" class="form-control" name="email" id="email" placeholder="Enter Email">
			        	<input type="text" class="form-control" name="password" id="password" placeholder="Enter Password">
			        	<input type="submit" class="btn btn-info btn-active" value="CREATE">	
		        	</form>
		        </div>
		        <div class="col-md-6">
		        	<h5 style="color:#049">LOGIN</h5>
		        	<form role="form" action="{% url 'login' %}" method="post">
			        {% csrf_token %}
			        	<input type="text" class="form-control" name="username" id="username" placeholder="Enter Username">
			        	<input type="text" class="form-control" name="password" id="password" placeholder="Enter Password">
			        	<input type="submit" class="btn btn-info btn-active" value="LOGIN">
		        	</form>
		        </div>
	        </div>
			<div class="modal-footer">
				<!-- <button type="button" class="btn btn-default" data-dismiss="modal">Close</button> -->
			</div>
	    </div>
		</div>
	</center>
	</div>
	<br>

	<!-- Sidebar -->
	<div class="col-md-4 pull-right">
		<h4>Related Subreddits</h4>
		{% if user.is_authenticated %}
		<h5><a href={% url 'newpost' %}>Submit a new post</a></h5>
		{% else %}
		<h5><a href="" data-toggle="modal" data-target="#myModal">Sign-in</a> to post</h5>
		{% endif %}
	</div>

	<!-- Main Content -->
	<div id="container">
		{% for p in posts %}
		<div class="col-md-8">	
			<div class="col-md-1" data-toggle="tooltip" title="Login to Vote">
				<span id="upvote" onclick="vote(this,{{p.id}}, 1)" class="glyphicon glyphicon-arrow-up" {% if p.vote == 1 %} style="color:green" {% endif %} aria-hidden="true"></span>
				<center>
					<p class="comments" id="votes">{{p.num_votes}}</p>
				</center>
				<span id="downvote" onclick="vote(this, {{p.id}}, -1)" class="glyphicon glyphicon-arrow-down" {% if p.vote == -1 %} style="color:red" {% endif %} aria-hidden="true"></span>
			</div>
			<div class="col-md-2">
				<img src={% static "images/a.png" %} style="width:60px;height:60px;">
			</div>
			<div class="col-md-9">
				{% if p.type == 'text' %}
				<a href={% url 'post' p.id %}>{{p.title}}</a> 
				{% else %}
				<a href={{p.link}}>{{p.title}}</a>
				{% endif %}
				<p class="comments">Posted By: <a href={% url 'user' p.posted_by %} class="comments">{{ p.posted_by }}</a></p>
				<p class="comments" id="time">{{p.created_on}}</p>
				<p class="comments"><a href={% url 'post' p.id %} class="comments">{{p.num_comments}} 
				{% if p.num_comments < 2 %}comment{%else %}comments{%endif %}</a> points</p> 

			</div>
		</div>
		{% endfor%}
	</div>

	<script type="text/javascript" src={% static "js/bootstrap.js" %}></script>
</body>
</html>